name: Deploy Web Map to S3

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3️⃣ Create S3 bucket if it doesn't exist
      - name: Create S3 bucket if needed
        run: |
          if ! aws s3api head-bucket --bucket "${{ secrets.S3_BUCKET }}" 2>/dev/null; then
            if [ "${{ secrets.AWS_REGION }}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "${{ secrets.S3_BUCKET }}"
            else
              aws s3api create-bucket \
                --bucket "${{ secrets.S3_BUCKET }}" \
                --region "${{ secrets.AWS_REGION }}" \
                --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
            fi
          fi

      # 4️⃣ Enable static website hosting
      - name: Enable static website hosting
        run: |
          aws s3api put-bucket-website \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --website-configuration '{
              "IndexDocument": {"Suffix": "index.html"},
              "ErrorDocument": {"Key": "index.html"}
            }'

      # 5️⃣ Disable S3 block public access
      - name: Disable block public access
        run: |
          aws s3api put-public-access-block \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false

      # 6️⃣ Set public-read bucket policy
      - name: Make bucket public
        run: |
          aws s3api put-bucket-policy \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "PublicReadGetObject",
                  "Effect": "Allow",
                  "Principal": "*",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::${{ secrets.S3_BUCKET }}/*"
                }
              ]
            }'

      # 7️⃣ Upload all HTML, CSS, JS to root
      - name: Upload web map files
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET }} \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "data/*.geojson"

      # 8️⃣ Upload GeoJSON files uncompressed
      - name: Upload GeoJSON files
        run: |
          mkdir -p tmp
          for file in data/*.geojson; do
            aws s3 cp "$file" "s3://${{ secrets.S3_BUCKET }}/data/$(basename "$file")" \
              --content-type application/geo+json
          done

      # 9️⃣ Print website URL
      - name: Print website URL
        run: echo "Your web map is available at: http://${{ secrets.S3_BUCKET }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com"
