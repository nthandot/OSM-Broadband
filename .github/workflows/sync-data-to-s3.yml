name: Create Bucket and Upload GeoJSON

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create bucket if needed
        run: |
          if ! aws s3api head-bucket --bucket "${{ secrets.S3_BUCKET }}" 2>/dev/null; then
            if [ "${{ secrets.AWS_REGION }}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "${{ secrets.S3_BUCKET }}"
            else
              aws s3api create-bucket \
                --bucket "${{ secrets.S3_BUCKET }}" \
                --region "${{ secrets.AWS_REGION }}" \
                --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
            fi
          fi

      - name: Verify bucket exists
        run: aws s3 ls s3://${{ secrets.S3_BUCKET }}

      - name: Gzip and upload GeoJSON
        run: |
          for file in data/*.geojson; do
            gzip -c "$file" > "$file.gz"
            aws s3 cp "$file.gz" "s3://${{ secrets.S3_BUCKET }}/$file" \
              --content-type application/geo+json \
              --content-encoding gzip
            rm "$file.gz"
          done
