name: Create Bucket and Upload GeoJSON

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Debug bucket name length
        run: echo "Bucket name length is ${#S3_BUCKET}"
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
    
      - name: Create bucket if needed
        run: |
          if ! aws s3api head-bucket --bucket "${{ secrets.S3_BUCKET }}" 2>/dev/null; then
            if [ "${{ secrets.AWS_REGION }}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "${{ secrets.S3_BUCKET }}"
            else
              aws s3api create-bucket \
                --bucket "${{ secrets.S3_BUCKET }}" \
                --region "${{ secrets.AWS_REGION }}" \
                --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
            fi
          fi

      - name: Verify bucket exists
        run: aws s3 ls s3://${{ secrets.S3_BUCKET }}

      - name: Gzip and upload GeoJSON
        run: |
          for file in data/*.geojson; do
            gzip -c "$file" > "$file.gz"
            aws s3 cp "$file.gz" "s3://${{ secrets.S3_BUCKET }}/$file" \
              --content-type application/geo+json \
              --content-encoding gzip
            rm "$file.gz"
          done
      
      - name: Enable static website hosting
        run: |
          aws s3api put-bucket-website \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --website-configuration '{
              "IndexDocument": {"Suffix": "index.html"},
              "ErrorDocument": {"Key": "index.html"}
            }'

      - name: Disable block public access
        run: |
          aws s3api put-public-access-block \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false

      - name: Make bucket public
        run: |
          aws s3api put-bucket-policy \
            --bucket "${{ secrets.S3_BUCKET }}" \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "PublicReadGetObject",
                  "Effect": "Allow",
                  "Principal": "*",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::${{ secrets.S3_BUCKET }}/*"
                }
              ]
            }'

      - name: Upload files to S3
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET }} --delete --exclude ".git/*" --exclude ".github/*"
